name: Python Linters

on:
  pull_request:
    branches: [main, master, QA]

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v2
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Install Python
        uses: "actions/setup-python@v2"

      - name: Get changed files
        id: get_file_changes
        uses: trilom/file-changes-action@v1.2.4
        with:
          output: ' '

      - name: Get changed .py files in /models to lint
        id: get_py_files
        shell: bash -l {0}
        run: |
          # Set the command in the $() brackets as an output to use in later steps
          echo "::set-output name=to_lint::$(
          # Issue where grep regular expressions don't work as expected on the
          # Github Actions shell, check dbt/models/ folder
          echo \
          $(echo ${{ steps.get_file_changes.outputs.files_modified }} |
          tr -s ' ' '\n' |
          grep -E '^*[.]py' |
          tr -s '\n' ' ') \
          $(echo ${{ steps.get_file_changes.outputs.files_added }} |
          tr -s ' ' '\n' |
          grep -E '^*[.]py' |
          tr -s '\n' ' ')
          )"

      - name: isort
        uses: isort/isort-action@master
        with:
          sortPaths: ${{ steps.get_py_files.outputs.to_lint }}
          configuration: ''

      - name: black
        uses: psf/black@stable
        with:
          src: ${{ steps.get_py_files.outputs.to_lint }}
          options:  '--verbose'

      - name: autopep8
        uses: peter-evans/autopep8@v1
        with:
          args: --recursive --in-place --aggressive --aggressive ${{ steps.get_py_files.outputs.to_lint }}

      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          author_name: Git Actions - Linters
          message: '[Git Action] Python auto-linting'
          add: '.'

      - name: pylint
        run: |
          pip install pylint
          results=pylint ${{ steps.get_py_files.outputs.to_lint }} --exit-zero
          echo "::set-output name=results::$results"

      - name: comment pr
        uses: mshick/add-pr-comment@v1
        with:
          message: |
            ${{ steps.pylint.outputs.results }}
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          repo-token-user-login: 'github-actions[bot]' # The user.login for temporary GitHub tokens
          allow-repeats: false # This is the default

